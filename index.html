// --- Configuration ---
// !!! REPLACE WITH YOUR ACTUAL EPA CTX API KEY !!!
const EPA_API_KEY = 'YOUR_API_KEY_HERE';

// Updated Base URL - EPA CompTox Dashboard API
const API_BASE_URL = 'https://api-ccte.epa.gov/data-resolver/v1';

// API Endpoints
async function fetchData() {
    const identifier = chemIdInput.value.trim();
    if (!identifier) {
        showError("Please enter a CAS RN or DTXSID.");
        return;
    }
    if (EPA_API_KEY === 'YOUR_API_KEY_HERE') {
        showError("Please add your EPA CTX API Key to the JavaScript code first.");
        return;
    }

    clearPreviousResults();
    statusDiv.style.display = 'block';
    resultIdentifierSpan.textContent = identifier;
    jsonOutputDiv.innerHTML = ''; // Clear previous JSON

    let dtxsid = null;
    let fetchedJsonResponses = {}; // Store JSON responses

    try {
        // Step 1: Determine identifier type and get DTXSID if necessary
        if (identifier.toUpperCase().startsWith('DTXSID')) {
            dtxsid = identifier.toUpperCase();
        } else if (identifier.includes('-')) { // Assume CAS RN if it contains hyphens
            statusDiv.textContent = `Looking up DTXSID for CAS RN: ${identifier}...`;
            
            // CORRECTED: Endpoint to get DTXSID from CAS RN
            const searchUrl = `${API_BASE_URL}/chemicals/search/exactMatch/${encodeURIComponent(identifier)}`;
            const searchResponse = await makeApiCall('CAS_Search', searchUrl, fetchedJsonResponses);

            // Extract DTXSID from search response
            if (searchResponse && Array.isArray(searchResponse) && searchResponse.length > 0 && searchResponse[0].dtxsid) {
                dtxsid = searchResponse[0].dtxsid;
                statusDiv.textContent = `Found DTXSID: ${dtxsid}. Fetching details...`;
            } else if (searchResponse && searchResponse.dtxsid) {
                dtxsid = searchResponse.dtxsid;
                statusDiv.textContent = `Found DTXSID: ${dtxsid}. Fetching details...`;
            } else {
                throw new Error(`Could not find DTXSID for CAS RN ${identifier}. Response: ${JSON.stringify(searchResponse)}`);
            }
        } else {
            throw new Error("Invalid identifier format. Use CAS RN (e.g., 67-64-1) or DTXSID (e.g., DTXSID7020182).");
        }

        if (!dtxsid) {
            throw new Error("Failed to obtain DTXSID.");
        }

        // Step 2: Fetch Chemical Details using DTXSID
        statusDiv.textContent = `Fetching Chemical Details for ${dtxsid}...`;
        
        // CORRECTED: Endpoint for chemical details
        const detailsUrl = `${API_BASE_URL}/chemicals/details/${dtxsid}`;
        const detailsData = await makeApiCall('Chemical_Details', detailsUrl, fetchedJsonResponses);
        displayChemicalDetails(detailsData, dtxsid);

        // Step 3: Fetch Hazard Data (including GHS) using DTXSID
        statusDiv.textContent = `Fetching Hazard Data for ${dtxsid}...`;
        
        // CORRECTED: Endpoint for hazard data
        const hazardUrl = `${API_BASE_URL}/chemicals/hazard-records/${dtxsid}`;
        const hazardData = await makeApiCall('Hazard_Data', hazardUrl, fetchedJsonResponses);
        displayHazardInfo(hazardData);

        // Step 4: Fetch Physicochemical Property Data using DTXSID
        statusDiv.textContent = `Fetching PhysChem Properties for ${dtxsid}...`;
        
        // CORRECTED: Endpoint for physicochemical properties
        const physChemUrl = `${API_BASE_URL}/chemicals/properties/${dtxsid}`;
        const physChemData = await makeApiCall('PhysChem_Data', physChemUrl, fetchedJsonResponses);
        displayPhysChemInfo(physChemData);

        // CORRECTED: Chemical structure image URL
        const imageUrl = `${API_BASE_URL}/chemicals/structure-image/${dtxsid}`;
        detailsImage.src = imageUrl;
        detailsImage.style.display = 'block';
        detailsImage.onerror = () => { detailsImage.style.display = 'none'; }

        resultsDiv.style.display = 'block'; // Show results section
        rawJsonDisplayDiv.style.display = 'block'; // Show JSON section

    } catch (error) {
        showError(`Error: ${error.message}`);
        console.error("Fetch error:", error);
        displayRawJson(fetchedJsonResponses); // Display JSON even if later calls fail
        rawJsonDisplayDiv.style.display = 'block';
    } finally {
        statusDiv.style.display = 'none'; // Hide loading message
    }
}

// Improved API call function with better error handling
async function makeApiCall(callName, url, jsonStorage) {
    try {
        const response = await fetch(url, {
            headers: {
                'x-api-key': EPA_API_KEY,
                'Accept': 'application/json'
            }
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`API call '${callName}' failed: ${response.status} ${response.statusText}. Response: ${errorText}`);
        }

        const data = await response.json();
        jsonStorage[callName] = data; // Store successful response
        return data;
    } catch (error) {
        jsonStorage[callName] = { error: error.message }; // Store error info
        throw error; // Re-throw to stop subsequent calls if needed
    }
}
